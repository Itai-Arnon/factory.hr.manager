<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- import of axios-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.2.1/axios.min.js"></script>
	<script src="../utils/actions.js"></script>

	<link rel="stylesheet" href="../css/editEmp.css">

	<style>
		.btn {

			width: 50%;
		}

		.no-pressbutton {
			width: 50%;
		}

		input {
			width: 40%;
			font-size: 1rem;
		}
	</style>
	<title>Departments Editor</title>
</head>

<body onload="init()">
	<div class="user-login">
		<h5 id="userElement"></h5>
	</div>
	<h1 class="head1">Department Editor</h1>
	<!-- text boxes shift tables -->
	<div class="main">
		<div class="left-container">
			<h4> Press Edit To Start Editting This Department</h4>

			Name:<select id="dept-dropdown" style="width:70%;">
				<option value="0" selected> Select a Department </option>
			</select>

			<input type="hidden" id="current-dept-id">
			<input type="hidden" id="current-dept-name">
			<!--- add hidden input to storde id-->
			<button class="no-pressbutton" name="enter-name">Edit</button> <br><br>
			<button onclick="(function act1(){allRelevantEmployees(true)})()" name="showDepartmentEmployees"
				class="btn">Show Employees Belongning To The Department</button>
			<button onclick="(function act2(){allRelevantEmployees(false)})()" name="showNonDepartmentEmployees"
				class="btn">Register Employees Department</button>
			<br><br>
			<!---function 0-->



			<h2 class="instruction"> Fill In Parameters For Update</h2>
			Department Name: <input type="text" id="dept-name" size="30" /> <br>
			Manager Name: <select id="manager-dropdown" style="width:70%;">
				<option value="0" selected> Select a Manager </option>
			</select><br />
			<input type="hidden" id="dept-id"> <!---store dept id-->
			<button onclick="updateDept()" name="updateDept" class="btn" size="40">Update Department's Details</button>
			<!---function 1-->



			<h2 class="instruction">Delete Department and Its Employees </h2>
			Name: <input type="text" id="delete-name" size="40" /> <br>
			<input type="hidden" id="delete-id">
			<button id="deleteDept" class="btn">Delete</button> <!---function 2-->


		</div> <!-- end left container -->


		<div class="right-container">
			<!-- add invisibility here-->
			<h4 id="table-container-text"></h4>
			<div id="table-container"></div>

			<h4 id="select-container-text"></h4>
			<div id="select-container">
			</div><br style="line-height:3em">
			<h4></h4>
			<!-- temporary text and table -->
			<table id="t-move"></table>

			<button style="width:50%;" onclick="clearTables()" class="btn" size="40" name="clearTables">Clear All
				Tables</button>
			<!---function 4-->
			<button style="width:50%;" onclick="clearText()" class="btn" name="clearText">Clear All Text
				Fields</button><br><!---function 5-->
			<button style="width:50%;" onclick="(function ret(){window.location.href='./departments.html'})()">Go Back
				To Departments</button>
			<button style="width:50%;" onclick="(function ret(){window.location.href='./employees.html'})()">Go Back To
				Employees</button>
			<button style="width:50%;" id="logout"
				onclick="(function ret(){window.location.href='./index.html'})()">Logout</button>

			<div id="alert">
				<h4 id="msg"> </h4>
			</div>

		</div>

		<!-- at some point add messages-->
	</div>
</body>

<script>


	//tables containers are called container 1 and container 2
	let manager_select = document.getElementById('manager-dropdown'); //html element
	let dept_name_select = document.getElementById("dept-dropdown");//html element
	let alert_msg = document.querySelector("#alert")//html element
	let msg = alert_msg.querySelector("#msg")//html element
	let select_container_text = document.querySelector("#select-container-text")//html element
	let table_container_text = document.querySelector("#table-container-text")//html element
	let select_container = document.querySelector("#select-container")
	let table_move = document.querySelector("#t-move");//html element
	let apiAction //axios object
	let isDataValid = false
	let departments // data is global and save redundant fetch
	let employees// data is global and save redundant fetch
	let set_dept_id = null
	let set_dept_name = null
	let sentDepartment = null
	let set_manager_id = null
	let _insertSession = true //ensure session object is injected only once
	let _token



	const url_connectors = `http://localhost:3000/connectors`
	const url_shifts = `http://localhost:3000/shifts`
	const url_employees = `http://localhost:3000/employees`
	const url_departments = `http://localhost:3000/departments`

	async function fetchData() {
		({ data: employees } = await apiAction.get(url_employees));
		({ data: departments } = await apiAction.get(url_departments));


		if (!employees || !departments) {
			isDataValid = false;
			message(8)
		}
		else {
			isDataValid = true;
			message(12);
		}

	}

	async function init() {
		addToken();
		await fetchData();

		//fill dropdowsn and check for session Storage
		if (isDataValid == true ) {
			fillNameDropdown() //fills the dept names
			fillManagerDropdown() //fills the dept names

			sentDepartment = JSON.parse(sessionStorage.getItem("department"))
			console.log({ sentDept: sentDepartment })

			if (sentDepartment && _insertSession) {//_insert session if false - session will be inserted only once

				setDetails(sentDepartment)
				isDepratment()
				_insertSession = false //session will be insterted only once
			}

			//defining submit button
			const input_name = document.querySelector(".no-pressbutton")
			input_name.addEventListener("click", isDepratment)
			//defining deleteDept button
			const deleteButton = document.querySelector("#deleteDept").addEventListener("click", deleteDept = (ev) => {
				deleteDept(ev);
			})

		} else message(8);
	}


	async function isDepratment() {

		set_dept_id = dept_name_select[dept_name_select.selectedIndex].value;
		console.log({ info: dept_name_select[dept_name_select.selectedIndex].value });
		const dept = departments.find(dept => String(dept._id) === set_dept_id);
		clearAll()
		setDetails(dept)//insert the details of the dept into the textboxes
		allRelevantEmployees(false)
		message(1)
	}




	function setDetails(_dept) {
		//values of select option are the dept id 
		if (_insertSession) {
			//define select
			// if (i === 1) opt.selected = true
			dept_name_select.value = sentDepartment._id
			manager_select.value = sentDepartment.managerId;
			//define other vars
			set_manager_id = sentDepartment.managerId; //hidden textboxes - store info for the entire process
			set_dept_id = sentDepartment._id
			set_dept_name = sentDepartment.name
		}
		else {
			//define select
			dept_name_select.value = _dept._id
			manager_select.value = _dept.managerId
			//define other vars	
			set_manager_id = _dept.managerId; //hidden textboxes - store info for the entire process
			set_dept_id = _dept._id
		}
		//set hidden textboxes
		document.getElementById("dept-id").value = _dept._id;
		document.getElementById("dept-name").value = _dept.name;
		document.getElementById("delete-id").value = _dept._id
		document.getElementById("delete-name").value = _dept.name
	}


	function fillNameDropdown() { //presents the department you want to edit
		

		for (let i = 0; i < departments.length; i++) {
			let opt = document.createElement('option');
			opt.value = departments[i]._id;
			opt.innerHTML = departments[i].name;
			if (i === 1) opt.selected = true

			dept_name_select.appendChild(opt);
		}
	}




	function fillManagerDropdown() {
		
		//dynamic part of dropdown
		employees.forEach(emp => {
			let opt = document.createElement('option');
			opt.value = emp._id;
			opt.text = `${emp.firstname}${emp.lastname}`;
			manager_select.appendChild(opt);
		});

	}



	function addToken() { //inserts token into each http method
		_token = sessionStorage.getItem("token")
		apiAction = axios.create({
			headers: {
				'Content-Type': 'application/json',
				'x-access-token': _token
			}
		});
	}



	function message(num) {
		switch (num) {
			case 0: // unverrified name isEmployee
				msg.innerHTML = "Invalid Name"
				alert_msg.appendChild(msg)
				break;
			case 1: // verrified name isEmployee
				msg.innerHTML = "Verified"
				alert_msg.appendChild(msg)
				break;
			case 2://bad parameters
				msg.innerHTML = "Invalid Employee"
				alert_msg.appendChild(msg)
				break;
			case 3://data added on table 
				msg.innerHTML = "Employee Invalid"
				alert_msg.appendChild(msg)
				break;
			case 4://data edit Employee param mistake 
				msg.innerHTML = "Employee is Already Registered to all shifts"
				alert_msg.appendChild(msg)
				break;
			case 5: // writeToTable params
				msg.innerHTML = "Bad Parmas"
				alert_msg.appendChild(msg)
				break;
			case 6: //delete employee - does current_id exists 
				msg.innerHTML = "Page will reload now"
				alert_msg.appendChild(msg)
				break;
			case 7: //data added on table 
				msg.innerHTML = "Department Id is Invalid"
				alert_msg.appendChild(msg)
				break;
			case 8: //createTable
				msg.innerHTML = "No Data Found"
				alert_msg.appendChild(msg)
				break;
			case 9://update
				msg.innerHTML = "Bad Params"
				alert_msg.appendChild(msg)
				break;
			case 10: //writeToTableDept 
				msg.innerHTML = "Data Written"
				alert_msg.appendChild(msg)
				break;
			case 11: //delete 
				msg.innerHTML = "Data Deleted"
				alert_msg.appendChild(msg)
				break;
			case 12: //data_fetched 
				msg.innerHTML = "Data Fetched "
				alert_msg.appendChild(msg)
				break;


		}
		setTimeout(() => {
			msg.innerHTML = null

		}, 3000);

	}




</script>

</html>